<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Making a Discord Bot with Godot (Part Two)</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Website of Orama Interactive"><meta name=author content="Orama Interactive"><meta name=generator content="Hugo 0.119.0"><link rel=stylesheet href=https://www.oramainteractive.com/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://www.oramainteractive.com/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://www.oramainteractive.com/plugins/fontawesome-free-6.0.0-web/all.min.css><link rel=stylesheet href=https://www.oramainteractive.com/plugins/magnific-popup/magnific-popup.css><link rel=stylesheet href=https://www.oramainteractive.com/plugins/slick/slick.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Anaheim%7cQuattrocento+Sans:400,700&amp;display=swap"><link rel=stylesheet href=https://www.oramainteractive.com/css/style.min.css media=screen><link rel=stylesheet href=https://www.oramainteractive.com/css/custom.min.css media=screen><link rel="shortcut icon" href=https://www.oramainteractive.com/images/favicon.png type=image/x-icon><link rel=icon href=https://www.oramainteractive.com/images/favicon.png type=image/x-icon></head><body id=body data-spy=scroll data-target=.navbar data-offset=55><div id=content><section class="sticky-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-dark"><a class="navbar-brand p-0" href=/><img class=lozad data-src=https://www.oramainteractive.com/images/orama_logo.svg alt="Orama Interactive" height=42></a>
<button class="navbar-toggler rounded-0" type=button data-toggle=collapse data-target=#navigation>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/#about>About</a></li><li class=nav-item><a class=nav-link href=/#portfolio>Projects</a></li><li class=nav-item><a class=nav-link href=/#team>Team</a></li><li class=nav-item><a class=nav-link href=/#blog>Blog</a></li><li class=nav-item><a class=nav-link href=/#contact>Contact</a></li></ul><select id=select-language onchange="location=this.value"><option id=en value=https://www.oramainteractive.com/blog/making-a-discord-bot-with-godot-part-two/ selected>English</option></select></div></nav></div></section><section class=section><div class=container><div class=row><div class="col-lg-8 offset-lg-2 text-center"><h1>Making a Discord Bot with Godot (Part Two)</h1><ul class="list-inline mb-50"><li class=list-inline-item><a href=/author/emmanouil-papadeas/>Emmanouil Papadeas</a></li><li class=list-inline-item>Wednesday, Jul 3, 2019</li></ul><img class="img-fluid mb-50 lozad" data-src=https://www.oramainteractive.com/images/blog/making-a-discord-bot-in-godot/godot.webp alt=blog-image></div><div class="col-lg-8 offset-lg-2"><div class=post-single-content><p>This is a continuation from Part One, which you can find <a href=../making-a-discord-bot-with-godot-part-one>here</a>.</p><p>Back for more I see? In the second part of this blog tutorial series we’re going to handle <strong>resuming</strong> our connection in case of a disconnection, disconnect in purpose if we don’t receive a <strong>Heartbeat ACK</strong>, and handle <strong>Opcode 9 Invalid Session</strong> payloads. So, let’s <em>resume</em> the tutorial! (See what I did there? Resume? Anyway, moving on)</p><p>Before we even begin, the first thing I’m going to do is rename our Timer node to “HeartbeatTimer”, have the heartbeat_interval variable converted to seconds from the moment we set a value for it (by doing <code>heartbeat_interval = dict["d"]["heartbeat_interval"] / 1000</code>), and replace the code inside our Opcode 0 Dispatch with a neat looking <code>handle_events(dict: Dictionary)</code> method. All the previous code will be put inside that new method, which will be used to, well, handle our events. The first event we’re going to handle is our Ready event. We’re going to need a new String variable called session_id, which we need in order to resume our connection. So, inside our new method, store the “t” field of our dictionary (this is the name of the event) and check if it is equal to “READY”. If it is, set our session_id variable to <code>dict["d"]["session_id"]</code>. Behold, it’s screenshot time!</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/6.webp alt></p><p>Ah, much better. Reminder that this is inside our <code>_data_received()</code> method.</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/7.webp alt>
And our new baby, <code>handle_events()</code>. Don’t forget to initialize session_id as a String variable at the top of our script!</p><p>All is going well and our bot is work- nope, we disconnected. Oh well, that happens all the time anyway. So, how do we handle it? Well first of all, we need to tell our client to reconnect. So, in our process method, we and an else statement to check if the client is disconnected, and if it is, we tell it to connect to the Gateway’s URL. Oh, and before I forget, we can connect the WebSocketClient’s connection_closed and server_close_request signals to two new methods. Τhe first method will just print to the console that we got disconnected, and the second one will print that the server has requested a clean close, along with the <a href=https://discordapp.com/developers/docs/topics/opcodes-and-status-codes#gateway-gateway-close-event-codes>close event code and reason</a>. If the client manages to connect again, it will receive an Opcode 10 Hello payload. We don’t, however, have to identify ourselves again. We can do a check if we have a session_id, and if we do, we can send an Opcode 6 Resume payload to the Gateway instead. The 3 fields that are required for that payload is the bot’s <strong>token</strong>, the <strong>session_id</strong> and the <strong>last_sequence</strong> number.
<img src=../../images/blog/making-a-discord-bot-in-godot/8.webp alt>
Our new else statement inside our process method.</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/9.webp alt>
Updated our Opcode 10 Hello logic to handle resuming.</p><p>Now that we’re done with resuming, we’ll disconnect on purpose. Wait, what? Why? Because that’s what the <a href=https://discordapp.com/developers/docs/topics/gateway#heartbeating>Discord Developer Docs</a> say, my dear viewer!
“If a client does not receive a heartbeat ack between its attempts at sending heartbeats, it should immediately terminate the connection with a non-1000 close code, reconnect, and attempt to resume.“
And that’s exactly what we will do. For that, we need a new boolean variable called <strong>heartbeat_ack_received</strong>, set as true at the top of our script. We will set the variable as false every time we send an Opcode 1 Heartbeat payload, and then back to true when we receive an Opcode 11 Heartbeat ACK payload. Now, we have to check if the variable has remained false when we are about to send our next Opcode 1 Heartbeat. If it is false, meaning we haven’t received an Opcode 11 Heartbeat ACK, we terminate the connection with a non-1000 code and return from the method. To be honest, I don’t know if that is the best way of handling the situation, so, if you have any better ideas be sure to comment them down below! Some screenshots for your the pleasure of your eyes.</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/10.webp alt>
Remember to initialize your variables at the top of the script, kids.</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/11.webp alt>
Set heartbeat_ack_received to true when we RECEIVE a Heartbeat ACK</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/12.webp alt>
We check if heartbeat_ack_received is false when we are about to send a Heartbeat, and if it is, we terminate our connection with code 1002 (any non-1000 code should work fine? I guess?) and return from the method. If it is true, we send our Heartbeat as we usually would and we set heartbeat_ack_received to false.</p><p>And I think that’s it for handling disconnections, when we don’t receive Heartbeat ACK payloads. Last up for this part is handling Opcode 9 Invalid Session payloads. You can find more info on them on <a href=https://discordapp.com/developers/docs/topics/gateway#invalid-session>Discord’s docs</a>. This is again something that I’m not sure if my method is the best way of doing it, so if you have any objections, make sure to comment! Following instructions from the docs, when we receive an <strong>Opcode 9 Invalid Session</strong> payload, we have to wait a random time between 1 and 5 seconds, and then re-identify ourselves. Well, if the “d” field is false, that is. “d” is a boolean that indicates whether the session may be resumable. So if “d” is true, we’ll resume instead of re-identifying. So, we’ll create a new boolean variable at the top of our script called <strong>invalid_session_is_resumable</strong>, and at our ready method we’ll call <code>randomize()</code>, so the time the client has to wait after receiving the Opcode 9 payload will always be random. Then, we’ll create a new Timer Node as a child, which we will call “InvalidSessionTimer”, and we’ll do a new check to see if our op code is equal to “9”. If it is, we’ll set invalid_session_is_resumable to be equal to the “d” field of the payload, and we’ll set the InvalidSessionTimer’s wait time to <code>rand_range(1,5)</code>. We also need to make the timer’s <code>one_shot = true</code>, because we only want it to run only once every time we get an Opcode 9 Invalid Session payload, and then finally start it. We’ll connect InvalidSessionTimer’s timeout signal to a new method inside our script, where we’ll do pretty much the same we do with handling Opcode 10 Hello payloads, except the “setting up to send heartbeats” part. We’ll check if the invalid session is resumable AND if we have a session_id. If both are true, we’ll send a Resume payload. If at least one of them is false, we’ll send an Identify payload. Finally, it’s screenshot time.</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/13.webp alt></p><p>Don’t forget to declare the boolean variable at the top of the script and to call <code>randomize()</code>!</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/14.webp alt>
And I op- New code for handling Invalid Sessions</p><p><img src=../../images/blog/making-a-discord-bot-in-godot/15.webp alt>
Timeout method for InvalidSessionTimer</p><p>That’s all folks! For this part at least. You can find the <a href=https://pastebin.com/4yvDu4nU>code in pastebin</a>! Next up we have receiving messages and having the bot responding. Yes, time for some socialization! Make sure to follow this blog so you don’t miss the next part! See you then!</p></div><div class="social-share pt-4"><h4>Share:</h4><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.oramainteractive.com%2fblog%2fmaking-a-discord-bot-with-godot-part-two%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=Making%20a%20Discord%20Bot%20with%20Godot%20%28Part%20Two%29&amp;url=https%3a%2f%2fwww.oramainteractive.com%2fblog%2fmaking-a-discord-bot-with-godot-part-two%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5.0-4.55 2.04-4.55 4.54.0.36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3.0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35.0 12.92-6.92 12.92-12.93.0-.2.0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://plus.google.com/share?url=https%3a%2f%2fwww.oramainteractive.com%2fblog%2fmaking-a-discord-bot-with-godot-part-two%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--google resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.37 12.93c-.73-.52-1.4-1.27-1.4-1.5.0-.43.03-.63.98-1.37 1.23-.97 1.9-2.23 1.9-3.57.0-1.22-.36-2.3-1-3.05h.5c.1.0.2-.04.28-.1l1.36-.98c.16-.12.23-.34.17-.54-.07-.2-.25-.33-.46-.33H7.6c-.66.0-1.34.12-2 .35-2.23.76-3.78 2.66-3.78 4.6.0 2.76 2.13 4.85 5 4.9-.07.23-.1.45-.1.66.0.43.1.83.33 1.22h-.08c-2.72.0-5.17 1.34-6.1 3.32-.25.52-.37 1.04-.37 1.56.0.5.13.98.38 1.44.6 1.04 1.84 1.86 3.55 2.28.87.23 1.82.34 2.8.34.88.0 1.7-.1 2.5-.34 2.4-.7 3.97-2.48 3.97-4.54.0-1.97-.63-3.15-2.33-4.35zm-7.7 4.5c0-1.42 1.8-2.68 3.9-2.68h.05c.45.0.9.07 1.3.2l.42.28c.96.66 1.6 1.1 1.77 1.8.05.16.07.33.07.5.0 1.8-1.33 2.7-3.96 2.7-1.98.0-3.54-1.23-3.54-2.8zM5.54 3.9c.33-.38.75-.58 1.23-.58h.05c1.35.05 2.64 1.55 2.88 3.35.14 1.02-.08 1.97-.6 2.55-.32.37-.74.56-1.23.56h-.03c-1.32-.04-2.63-1.6-2.87-3.4-.13-1 .08-1.92.58-2.5zM23.5 9.5h-3v-3h-2v3h-3v2h3v3h2v-3h3"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Making%20a%20Discord%20Bot%20with%20Godot%20%28Part%20Two%29&amp;body=https%3a%2f%2fwww.oramainteractive.com%2fblog%2fmaking-a-discord-bot-with-godot-part-two%2f" target=_self rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 4H2C.9 4 0 4.9.0 6v12c0 1.1.9 2 2 2h20c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17.0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1.0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08.0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fwww.oramainteractive.com%2fblog%2fmaking-a-discord-bot-with-godot-part-two%2f&amp;resubmit=true&amp;title=Making%20a%20Discord%20Bot%20with%20Godot%20%28Part%20Two%29" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96.0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65.0 3-1.35 3-3s-1.35-3-3-3c-1.38.0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65.0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66.0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64.0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4.0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6.0.23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1.0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1.0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=Making%20a%20Discord%20Bot%20with%20Godot%20%28Part%20Two%29%20https%3a%2f%2fwww.oramainteractive.com%2fblog%2fmaking-a-discord-bot-with-godot-part-two%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://telegram.me/share/url?text=Making%20a%20Discord%20Bot%20with%20Godot%20%28Part%20Two%29&amp;url=https%3a%2f%2fwww.oramainteractive.com%2fblog%2fmaking-a-discord-bot-with-godot-part-two%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.707 8.475C.275 8.64.0 9.508.0 9.508s.284.867.718 1.03l5.09 1.897 1.986 6.38a1.102 1.102.0 001.75.527l2.96-2.41a.405.405.0 01.494-.013l5.34 3.87a1.1 1.1.0 001.046.135 1.1 1.1.0 00.682-.803l3.91-18.795A1.102 1.102.0 0022.5.075L.706 8.475z"/></svg></div></div></a></div><div class=mt-5></div></div></div></div></section></div><footer id=footer class=section-bg><div class=container><div class="row wow fadeInUp" data-wow-duration=500ms><div class=col-xl-12><div class=social-icon><ul class=list-inline><li class=list-inline-item><a rel=me href=mailto:oramagamestudios@gmail.com><i class="fa-regular fa-envelope"></i></a></li><li class=list-inline-item><a rel=me href=https://orama-interactive.itch.io/><i class="fa-brands fa-itch-io"></i></a></li><li class=list-inline-item><a rel=me href=https://mastodon.gamedev.place/@OramaInteractive><i class="fa-brands fa-mastodon"></i></a></li><li class=list-inline-item><a rel=me href=https://github.com/Orama-Interactive><i class="fa-brands fa-github"></i></a></li><li class=list-inline-item><a rel=me href=https://www.youtube.com/c/OramaInteractive><i class="fa-brands fa-youtube"></i></a></li><li class=list-inline-item><a rel=me href=https://twitter.com/OramaInteractiv><i class="fa-brands fa-twitter"></i></a></li><li class=list-inline-item><a rel=me href=https://www.facebook.com/orama.interactive/><i class="fa-brands fa-facebook"></i></a></li><li class=list-inline-item><a rel=me href=https://www.instagram.com/orama_interactive/><i class="fa-brands fa-instagram"></i></a></li></ul></div><div class="copyright text-center"><a href=https://www.oramainteractive.com/><img src=https://www.oramainteractive.com/images/orama_logo.svg alt="Orama Interactive" height=42></a><br><p></p></div></div></div></div></footer><script src=https://www.oramainteractive.com/plugins/jquery/jquery.min.js></script>
<script src=https://www.oramainteractive.com/plugins/bootstrap/bootstrap.min.js></script>
<script src=https://www.oramainteractive.com/plugins/slick/slick.min.js></script>
<script src=https://www.oramainteractive.com/plugins/shuffle/shuffle.min.js></script>
<script src=https://www.oramainteractive.com/plugins/magnific-popup/jquery.magnific-popup.min.js></script>
<script src=https://www.oramainteractive.com/plugins/lazy-load/lozad.min.js></script>
<script src=https://www.oramainteractive.com/plugins/google-map/map.js></script>
<script src=https://www.oramainteractive.com/js/script.min.ab3836b70bc45170e8ff6dd572ee5e8e761ac8376daf9ceb40f760dfb6f2cce49672517da770a0049959f5fc93337e13.js integrity=sha384-qzg2twvEUXDo/23Vcu5ejnYayDdtr5zrQPdg37byzOSWclF9p3CgBJlZ9fyTM34T></script></body></html>